; Copy program to copy and run the UART bootloader from RAM
Main:

    ; We start the bootloader by clearing the cache and registers in case of a reset
    load 0 r1
    load 0 r2
    load 0 r3
    load 0 r4
    load 0 r5
    load 0 r6
    load 0 r7
    load 0 r8
    load 0 r9
    load 0 r10
    load 0 r11
    load 0 r12
    load 0 r13
    load 0 r14
    load 0 r15

    nop
    nop
    ccache ; Clear cache
    nop
    nop



    load32 87 r1 ; Program length, hardcoded but could be read from the third byte of the program
    addr2reg UART_Bootloader_RAM_code r2
    load 0 r3  ; Loop counter
    load32 0 r5 ; Dest address start

    CopyLoop:
        read 0 r2 r4 ; Read word from UART_Bootloader_RAM_code
        write 0 r5 r4 ; Write word to RAM
        add r3 1 r3 ; Increment counter
        add r5 1 r5 ; Increment dest address
        add r2 1 r2 ; Increment source address
        beq r1 r3 2 ; If done, exit loop
        jump CopyLoop

    ; Clear cache and regs

    nop
    nop
    ccache
    nop
    nop

    load 0 r1
    load 0 r2
    load 0 r3
    load 0 r4
    load 0 r5
    load 0 r6
    load 0 r7
    load 0 r8
    load 0 r9
    load 0 r10
    load 0 r11
    load 0 r12
    load 0 r13
    load 0 r14
    load 0 r15
    
    jump 0 ; Jump to start of RAM


UART_Bootloader_RAM_code:
    .dw 0b11111111111111111111111111111111
    .dw 0b10010000000000000000000010011000
    .dw 0b00000000000000000000000001010110
    .dw 0b11111111111111111111111111111111
    .dw 0b00011100000000000000000000110011
    .dw 0b00011101000001110000000000110011
    .dw 0b11100000000000000001001100000001
    .dw 0b00011100000000000000000000100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000001100000010001
    .dw 0b00011100000000000000000100100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000001000000010001
    .dw 0b00011100000000000000001000100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000000100000010001
    .dw 0b00000011000000000000111100011111
    .dw 0b00010011000000000000000111001100
    .dw 0b00011100000000000000010000100010
    .dw 0b01100000000000000010110000100000
    .dw 0b01000000000000000000000000000000
    .dw 0b00010110000000000001100011110001
    .dw 0b11010000000000000000001100010000
    .dw 0b00010110000000000001000011110001
    .dw 0b11010000000000000000001100010000
    .dw 0b00010110000000000000100011110001
    .dw 0b11010000000000000000001100010000
    .dw 0b00010110000000000000000011110001
    .dw 0b11010000000000000000001100010000
    .dw 0b00011100000000000000000110101010
    .dw 0b00011100000000000000000011001100
    .dw 0b01000000000000000000000000000000
    .dw 0b00011100000000000000000000110011
    .dw 0b00011101000001110000000000110011
    .dw 0b11100000000000000001001100000001
    .dw 0b00011100000000000000000000100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000001100000010001
    .dw 0b00011100000000000000000100100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000001000000010001
    .dw 0b00011100000000000000001000100010
    .dw 0b01100000000000000010001011001000
    .dw 0b00010101000000000000100000010001
    .dw 0b00000011000000000000110100011101
    .dw 0b00010011000000000000000111001100
    .dw 0b00011100000000000000010000100010
    .dw 0b01100000000000000010110000100000
    .dw 0b01000000000000000000000000000000
    .dw 0b11010000000000000000111011010000
    .dw 0b00010011000000000000000111101110
    .dw 0b00011100000000000000000011011101
    .dw 0b00011100000000000000000011001100
    .dw 0b01100000000000000010111011110000
    .dw 0b01000000000000000000000000000000
    .dw 0b00011100000000000110010000010001
    .dw 0b11010000000000000000001100010000
    .dw 0b00011100000000000000000000010001
    .dw 0b00011100000000000000000000100010
    .dw 0b00011100000000000000000000110011
    .dw 0b00011100000000000000000001000100
    .dw 0b00011100000000000000000001010101
    .dw 0b00011100000000000000000001100110
    .dw 0b00011100000000000000000001110111
    .dw 0b00011100000000000000000010001000
    .dw 0b00011100000000000000000010011001
    .dw 0b00011100000000000000000010101010
    .dw 0b00011100000000000000000010111011
    .dw 0b00011100000000000000000011001100
    .dw 0b00011100000000000000000011011101
    .dw 0b00011100000000000000000011101110
    .dw 0b00011100000000000000000011111111
    .dw 0b00000000000000000000000000000000
    .dw 0b01110000000000000000000000000000
    .dw 0b00000000000000000000000000000000
    .dw 0b01000000000000000000000000000000
    .dw 0b11000000000000000000000000000001
    .dw 0b00011100000000000000000100100010
    .dw 0b01100000000000000010000100100000
    .dw 0b01000000000000000000000000000000
    .dw 0b01100000000000000010001010100000
    .dw 0b10010000000000000000000000001000
    .dw 0b10010000000000000000000001000000
    .dw 0b00000000000000000000000000000000
    .dw 0b00000000000000000000000000000000
    .dw 0b00000000000000000000000000000000
    